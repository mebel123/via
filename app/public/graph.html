<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <title>Lucida Knowledge Graph</title>
    <style>
        body {
            margin: 0;
            background: #0e0e0e;
            color: #eee;
            font-family: sans-serif;
        }

        #graph {
            width: 100vw;
            height: 100vh;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div id="graph"></div>


<script>
    (function () {

        const PERSON_RADIUS = 96;
        const ORG_WIDTH = 240;
        const ORG_HEIGHT = 106;



        window.renderGraph = function renderGraph(model) {

            const links = model.edges.map(e => ({
                source: e.from,
                target: e.to,
                predicate: e.predicate,
                confidence: e.confidence
            }));

            const width = window.innerWidth;
            const height = window.innerHeight;

            const svg = d3.select("#graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(
                    d3.zoom().on("zoom", (event) => {
                        g.attr("transform", event.transform);
                    })
                );

            const g = svg.append("g");

            const color = (type) => {
                if (type === "person") return "#4FC3F7";
                if (type === "organization") return "#81C784";
                if (type === "document") return "#ff0044";
                return "#ccc";
            };

            const simulation = d3.forceSimulation(model.nodes)
                .force(
                    "link",
                    d3.forceLink(links)
                        .id(d => d.id)
                        .distance(140)
                        .strength(d => d.confidence ?? 0.7)
                )
                .force("charge", d3.forceManyBody().strength(-380))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force(
                    "collision",
                    d3.forceCollide().radius(d => {
                        if (d.type === "organization") return ORG_WIDTH;
                        if (d.type === "person") return PERSON_RADIUS * 2.0;
                        return ORG_WIDTH; // document
                    })
                );

            const link = g.append("g")
                .selectAll("line")
                .data(links)
                .enter()
                .append("line")
                .attr("stroke", d =>
                    d.predicate.startsWith("issued") ? "#FFB74D" : "#666"
                )
                .attr("stroke-dasharray", d =>
                    d.predicate.startsWith("issued") ? "2 3" :
                        (d.predicate === "has_role_at" && !d.role ? "4 4" : null)
                )
                .attr("stroke-opacity", d =>
                    d.predicate.startsWith("issued") ? 0.9 : 0.8
                )
                .attr("stroke-width", d => 1 + (d.confidence ?? 0.7) * 3);

            const linkLabel = g.append("g")
                .selectAll("text")
                .data(links)
                .enter()
                .append("text")
                .attr("font-size", "11px")
                .attr("fill", "#aaa")
                .attr("text-anchor", "middle")
                .attr("pointer-events", "none")
                .text(d => {
                    if (d.predicate === "has_role_at" && d.role) return d.role;
                    if (d.predicate === "has_role_at") return "associated";
                    if (d.predicate === "issued_by") return "issuer";
                    if (d.predicate === "issued_to") return "recipient";
                    return "";
                });

            const node = g.append("g")
                .selectAll("g")
                .data(model.nodes)
                .enter()
                .append("g")
                .call(
                    d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended)
                );

            // SHAPES
            node.append(d => {
                if (d.type === "organization") {
                    return document.createElementNS("http://www.w3.org/2000/svg", "rect");
                }
                if (d.type === "person") {
                    return document.createElementNS("http://www.w3.org/2000/svg", "circle");
                }
                return document.createElementNS("http://www.w3.org/2000/svg", "circle"); // document
            })
                .each(function (d) {
                    const el = d3.select(this);

                    if (d.type === "person") {
                        el
                            .attr("r", PERSON_RADIUS)
                            .attr("fill", color(d.type))
                            .attr("stroke", "#111")
                            .attr("stroke-width", 2);
                    } else if (d.type === "organization") {
                        el
                            .attr("width", ORG_WIDTH)
                            .attr("height", ORG_HEIGHT)
                            .attr("x", -ORG_WIDTH / 2)
                            .attr("y", -ORG_HEIGHT / 2)
                            .attr("rx", 10)
                            .attr("fill", color(d.type))
                            .attr("stroke", "#111")
                            .attr("stroke-width", 2);
                    } else if (d.type === "document") {
                        el
                            .attr("text-anchor", "middle")
                            .attr("dy", "0.35em")
                            .attr("fill", "#FFB74D")
                            .attr("font-size", "14px")
                            .attr("font-weight", "700")
                            .attr("letter-spacing", "0.06em")
                            .style("filter", "drop-shadow(0 0 2px rgba(255,183,77,0.6))")
                            .text(d.label.toUpperCase());
                    } else {
                        el
                            .attr("width", ORG_WIDTH)
                            .attr("height", ORG_HEIGHT)
                            .attr("x", -ORG_WIDTH / 2)
                            .attr("y", -ORG_HEIGHT / 2)
                            .attr("rx", 10)
                            .attr("fill", color(d.type))
                            .attr("stroke", "#FFF")
                            .attr("stroke-width", 2);
                    }
                });

            // ICONS for person + organization above label
            node.filter(d => d.type === "person" || d.type === "organization")
                .append("text")
                .attr("class", "material-icons")
                .attr("text-anchor", "middle")
                .attr("x", 60)
                .attr("y", d => d.type === "organization" ? -ORG_HEIGHT / 2 + 36 : -PERSON_RADIUS + 36)
                .attr("fill", "#222")
                .style("filter", "drop-shadow(0 0 2px rgba(255,255,255,0.25))")
                .attr("pointer-events", "none")
                .text(d => d.type === "person" ? "person" : "business");

            // LABELS for person + organization only
            node.filter(d => d.type !== "document")
                .append("text")
                .attr("paint-order", "stroke")
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("fill", "#111")
                .style("filter", "drop-shadow(0 0 2px rgba(255,255,255,0.35))")
                .attr("font-size", d => d.type === "organization" ? "14px" : "13px")
                .attr("font-weight", d => d.type === "organization" ? "600" : "500")
                .attr("pointer-events", "none")
                .text(d =>
                    d.label.length > 26
                        ? d.label.slice(0, 25) + "â€¦"
                        : d.label
                );

            // TOOLTIP
            node.append("title")
                .text(d => `${d.label}\n(${d.type})`);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                linkLabel
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);

                node
                    .attr("transform", d => `translate(${d.x}, ${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
    })();
</script>

<script>
    let MODEL = null;
    console.log("addEventListener");
    window.addEventListener("message", (event) => {
        console.log("message", event.data);

        if (event.data?.type === "KNOWLEDGE_GRAPH") {
            MODEL = event.data.payload;
            console.log("Graph model received", MODEL);
            renderGraph(MODEL);
        }
    });
    const container = document.getElementById("graph");
    const width = container.clientWidth;
    const height = 320;
    window.addEventListener("resize", () => {
        svg.attr("width", container.clientWidth);
        svg.attr("height", 320);
    });
</script>
</body>
</html>
